<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Pangolin Track</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <script>if ('serviceWorker' in navigator) {navigator.serviceWorker.register('/sw.js');}</script>

    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .header { background: #2c3e50; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .initials-box { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; }
        .initials-box span { font-size: 0.8rem; margin-right: 5px; opacity: 0.8; }
        #observer_initials { background: transparent; border: none; color: white; width: 40px; font-weight: bold; text-transform: uppercase; text-align: center; font-size: 1rem; outline: none; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 60px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; color: #777; cursor: pointer; }
        .nav-item.active { color: #2ecc71; font-weight: bold; border-top: 3px solid #2ecc71; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #2ecc71; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-outline { background: white; border: 2px solid #ddd; color: #555; }
        .btn-dashboard { background: #8e44ad; color: white; margin-bottom: 10px; text-decoration: none; display: block; text-align: center; padding: 15px; border-radius: 8px; font-weight: bold; }
        .btn-download { background: #e67e22; color: white; margin-bottom: 10px; text-decoration: none; display: block; text-align: center; padding: 15px; border-radius: 8px; font-weight: bold; }
        .pango-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .pango-item { background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 10px 0; text-align: center; font-weight: bold; cursor: pointer; }
        .pango-item.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1.1rem; }
        .status-msg { padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.9rem; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .history-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.85rem; display: flex; justify-content: space-between; color: #555; }
        .history-item:last-child { border-bottom: none; }
        .history-label { font-weight: bold; color: #2c3e50; }
        .acc-tag { font-size:0.75rem; color:#7f8c8d; background:#f0f0f0; padding:2px 5px; border-radius:4px; margin-left:5px; }
    </style>
</head>
<body>
    <div class="header">
        <div><h2 id="group_display">Loading...</h2><div style="font-size: 0.7rem; opacity: 0.8;">SESSION ID</div></div>
        <div class="initials-box"><span>USER:</span><input type="text" id="observer_initials" placeholder="--" maxlength="3" oninput="saveInitials()"></div>
    </div>

    <div id="tab-track" class="page active">
        
        <button onclick="confirmNewSession()" 
                class="btn btn-outline" 
                style="margin-bottom:15px; margin-top:0;" 
                title="Click here if you are tracking a new animal or moving to a new location.">
            ‚ûï Start New Triangulation
        </button>

        <div id="session_log_card" class="card" style="display:none; background:#e8f5e9; border:1px solid #c3e6cb;">
            <div style="font-size:0.85rem; color:#155724; font-weight:bold; margin-bottom:5px;">SESSION HISTORY</div>
            <div id="session_log_list"></div>
        </div>

        <div class="card">
            <h3>1. Select Animal</h3>
            <div id="pango_grid" class="pango-grid"></div>
            <div id="selected_display" style="text-align:right; color:#2ecc71; font-weight:bold; margin-top:5px;">None</div>
        </div>
        <div class="card">
            <h3>2. Location</h3>
            <input type="hidden" id="gps_accuracy_val" value="0">
            <div style="display:flex; gap:10px;"><input type="number" id="manual_lat" placeholder="Lat"><input type="number" id="manual_lon" placeholder="Lon"></div>
            <button onclick="getGPS()" class="btn btn-blue" style="padding:10px;">üìç Auto-Fill GPS</button>
            <div id="gps_status" style="text-align:center; color:#666; font-size:0.8rem; margin-top:5px;"></div>
        </div>
        <div class="card">
            <h3>3. Bearing</h3>
            <input type="number" id="bearing" placeholder="0-360">
        </div>
        <button onclick="saveData()" class="btn btn-primary">SAVE READING</button>
        <div id="save_msg" class="status-msg"></div>
    </div>

    <div id="tab-manage" class="page">
        <div class="card"><h3>Add Animal</h3><input type="text" id="new_animal_id" placeholder="ID"><button onclick="addAnimal()" class="btn btn-blue">Add</button></div>
        <div class="card"><h3>List</h3><ul id="animal_list_view" style="color:#555;"></ul></div>
    </div>

    <div id="tab-sync" class="page">
        <div class="card">
            <h3>Sync</h3>
            <p>Pending: <b id="pending_count">0</b></p>
            <button onclick="syncToServer()" class="btn btn-primary">‚òÅÔ∏è SYNC NOW</button>
            <div id="sync_log" class="status-msg"></div>
        </div>
        <div class="card">
            <h3>Analysis & Export</h3>
            <a href="/dashboard" class="btn-dashboard">üìä Open Map Dashboard</a>
            <a href="/download_fixes" class="btn-download">üìÇ Download Fixes (CSV)</a>
            <a href="/download_csv" style="display:block; text-align:center; color:#777; text-decoration:none; margin-top:10px;">Download Raw Data</a>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('track', this)"><div class="nav-icon">üì°</div><span>Track</span></div>
        <div class="nav-item" onclick="switchTab('manage', this)"><div class="nav-icon">üêæ</div><span>Animals</span></div>
        <div class="nav-item" onclick="switchTab('sync', this)"><div class="nav-icon">üîÑ</div><span>Sync</span></div>
    </div>

    <script>
        let animals = ["P01", "P02", "P03", "P04"];
        let selectedAnimal = null;
        let sessionId = localStorage.getItem('session_id');

        window.onload = function() {
            if(localStorage.getItem('observer_initials')) document.getElementById('observer_initials').value = localStorage.getItem('observer_initials');
            if(localStorage.getItem('my_animals')) animals = JSON.parse(localStorage.getItem('my_animals'));
            renderAnimals(); updatePendingCount(); renderSessionLog();
            if(!sessionId) forceNewSession(true); else document.getElementById('group_display').innerText = sessionId; 
            fetch('/get_animals').then(r=>r.json()).then(d=>{if(d.length){animals=d; localStorage.setItem('my_animals', JSON.stringify(animals)); renderAnimals();}}).catch(e=>{});
        }
        
        function saveInitials(){ localStorage.setItem('observer_initials', document.getElementById('observer_initials').value.toUpperCase()); }
        function switchTab(t,el){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); el.classList.add('active'); }
        
        function renderAnimals(){ 
            const g=document.getElementById('pango_grid'); const l=document.getElementById('animal_list_view'); g.innerHTML=''; l.innerHTML='';
            animals.forEach(id=>{
                let b=document.createElement('div'); b.className='pango-item'; b.innerText=id; 
                if(selectedAnimal===id) b.classList.add('selected');
                b.onclick=()=>{selectedAnimal=id; document.querySelectorAll('.pango-item').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); document.getElementById('selected_display').innerText=id;}
                g.appendChild(b);
                let li=document.createElement('li'); li.innerText=id; l.appendChild(li);
            });
        }
        function addAnimal(){ 
            const id=document.getElementById('new_animal_id').value.trim(); if(!id)return; 
            if(!animals.includes(id)){ animals.push(id); localStorage.setItem('my_animals', JSON.stringify(animals)); renderAnimals(); fetch('/add_animal', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:id})}).catch(e=>{}); }
        }

        function confirmNewSession() {
            if(confirm("Start a new triangulation session?\n\nOnly do this if you are starting to track a NEW animal or moving to a completely new location.")) {
                forceNewSession();
            }
        }

        function forceNewSession(skipAlert=false){ 
            const d = new Date(); const str = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
            let seq = parseInt(localStorage.getItem('session_sequence')||"0");
            if(!skipAlert) {
                if(localStorage.getItem('last_session_date')!==str){ seq=1; localStorage.setItem('last_session_date', str); } else { seq+=1; }
            } else {
                 if(!sessionId) seq+=1; 
            }
            localStorage.setItem('session_sequence', seq);
            sessionId=`Fix_${str}_${String(seq).padStart(2,'0')}`; 
            localStorage.setItem('session_id', sessionId);
            document.getElementById('group_display').innerText=sessionId; 
            renderSessionLog(); 
            if(!skipAlert) alert("New Session Started: "+sessionId);
        }
        
        function getGPS(){ 
            document.getElementById('gps_status').innerText="Locating..."; 
            navigator.geolocation.getCurrentPosition(p=>{
                document.getElementById('manual_lat').value=p.coords.latitude.toFixed(6); 
                document.getElementById('manual_lon').value=p.coords.longitude.toFixed(6);
                let acc = Math.round(p.coords.accuracy);
                document.getElementById('gps_accuracy_val').value = acc;
                document.getElementById('gps_status').innerText="‚úÖ Accuracy: " + acc + "m";
            }, e=>{document.getElementById('gps_status').innerText="Error: "+e.message});
        }
        
        function saveData(){
            const lat=document.getElementById('manual_lat').value;
            const lon=document.getElementById('manual_lon').value;
            const brg=document.getElementById('bearing').value;
            const init=document.getElementById('observer_initials').value;
            const acc=document.getElementById('gps_accuracy_val').value;

            if(!init || !selectedAnimal || !lat || !lon || !brg) { document.getElementById('save_msg').innerText="‚ö†Ô∏è Missing Fields!"; document.getElementById('save_msg').style.display="block"; return; }
            
            const rec={
                group_id:sessionId, 
                pango_id:selectedAnimal, 
                observer:init.toUpperCase(), 
                lat:parseFloat(lat), 
                lon:parseFloat(lon), 
                bearing:parseFloat(brg), 
                accuracy: parseInt(acc) || 0,
                time:new Date().toISOString()
            };
            
            let q=JSON.parse(localStorage.getItem('sync_queue')||"[]"); q.push(rec); localStorage.setItem('sync_queue', JSON.stringify(q));
            
            document.getElementById('save_msg').innerText=`‚úÖ Saved! (${q.length} pending)`; document.getElementById('save_msg').style.display="block";
            document.getElementById('bearing').value=""; 
            document.getElementById('gps_accuracy_val').value = "0"; 
            document.getElementById('gps_status').innerText="";

            updatePendingCount();
            renderSessionLog(); 
        }

        function renderSessionLog() {
            let queue = JSON.parse(localStorage.getItem('sync_queue') || "[]");
            let currentItems = queue.filter(item => item.group_id === sessionId);
            const listDiv = document.getElementById('session_log_list');
            const card = document.getElementById('session_log_card');
            
            if (currentItems.length > 0) {
                card.style.display = 'block';
                listDiv.innerHTML = '';
                currentItems.forEach((item, index) => {
                    let accText = item.accuracy > 0 ? `(¬±${item.accuracy}m)` : "";
                    let div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <span class="history-label">#${index+1}</span> 
                        <span>${item.lat.toFixed(4)}, ${item.lon.toFixed(4)} <span class="acc-tag">${accText}</span></span>
                        <span style="font-weight:bold; color:#d35400;">${item.bearing}¬∞</span>
                    `;
                    listDiv.appendChild(div);
                });
            } else { card.style.display = 'none'; }
        }

        function updatePendingCount(){ document.getElementById('pending_count').innerText = JSON.parse(localStorage.getItem('sync_queue')||"[]").length; }
        
        async function syncToServer(){
            let q=JSON.parse(localStorage.getItem('sync_queue')||"[]"); if(!q.length)return;
            document.getElementById('sync_log').style.display='block'; document.getElementById('sync_log').innerText="Syncing...";
            try{
                const r=await fetch('/sync', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(q)});
                if(r.ok){ const d=await r.json(); localStorage.removeItem('sync_queue'); updatePendingCount(); renderSessionLog(); document.getElementById('sync_log').innerHTML="<b>Sync Complete!</b><br>"+d.messages.join('<br>'); }
            }catch(e){ document.getElementById('sync_log').innerText="Sync Failed"; }
        }
    </script>
</body>
</html>