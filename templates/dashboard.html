<script>
    // Get token securely from Flask
    const MAPBOX_TOKEN = "{{ mapbox_token }}"; 
</script>

<script>
    // ... (previous code) ...

    function renderMap(data) {
        const list = document.getElementById('fix_list'); 
        list.innerHTML = "";
        document.getElementById('record_count').innerText = `${data.fixes.length} Fixes | ${data.raw.length} Readings`;
        
        // ... (clear layers logic) ...
        // ... (draw raw lines logic) ...

        // Draw Fixes
        if(data.fixes.length){
            const group = new L.featureGroup();
            data.fixes.forEach(f => {
                const m = L.marker([f.calc_lat, f.calc_lon], {icon: pangoIcon})
                    .addTo(map)
                    .bindPopup(`<b>${f.pango_id}</b><br>${f.timestamp}<br><i>${f.note}</i>`);
                group.addLayer(m);
                
                // COLOR CODE CARDS BASED ON ERROR
                let borderColor = "#2ecc71"; // Green (Good)
                let bgColor = "white";
                
                // Check if note contains high error
                if(f.note && f.note.includes("Err:")) {
                    const errVal = parseFloat(f.note.split("Err:")[1]);
                    if(errVal > 10.0) { // Threshold: 10 meters error
                        borderColor = "#f1c40f"; // Yellow (Warning)
                        bgColor = "#fffcf5";
                    }
                }

                const card = document.createElement('div'); 
                card.className = 'fix-card';
                card.style.borderLeftColor = borderColor;
                card.style.background = bgColor;
                
                card.innerHTML = `
                    <div onclick="toggleCard(this, ${f.calc_lat}, ${f.calc_lon})">
                        <b>${f.pango_id}</b> <span style="font-size:0.8em; color:#777;">${f.group_id}</span><br>
                        <small>${f.timestamp.substring(0,16)}</small><br>
                        ${f.calc_lat.toFixed(5)}, ${f.calc_lon.toFixed(5)}<br>
                        <i style="color:${borderColor === '#f1c40f' ? '#d35400' : '#777'}">${f.note || ''}</i>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-zoom" onclick="zoomTo(${f.calc_lat}, ${f.calc_lon})">Zoom</button>
                        <button class="btn btn-edit" onclick="editFix(${f.id}, '${f.pango_id}', '${f.note||''}')">Edit</button>
                        <button class="btn btn-del" onclick="deleteFix(${f.id})">Delete</button>
                    </div>
                `;
                list.appendChild(card);
            });
            map.fitBounds(group.getBounds(), {padding:[50,50]});
        }
        // ... (rest of code)
    }
</script>
